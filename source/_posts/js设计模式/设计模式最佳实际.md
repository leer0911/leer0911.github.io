---
title: 设计模式最佳实践
---

# 单例模式

使用闭包封装私有变量

```javascript
var user = (function () {
    var __name = 'sven',
        __age = 29;

    return {
      getUserInfo: function () {
        return __name + '-' + __age;
      }
    }
  })();
```

基于类的惰性单例

```javascript
singleton.getInstance = (function () {
  var instance = null;
  return function (name) {
    if (!instance) {
      instance = new singleton(name);
    }
    return instance;
  }
})();
```

通用的惰性单例

## 创建浮窗

```javascript
var getSingle = function (fn) {
  var result;
  return function () {
    return result || (result = fn.apply(this,arguments));
  }
}

var createLoginLayer = function () {
  var div = document.createElement('div');
  div.innerHTML = '我是登录浮窗';
  div.style.display = 'none';
  document.body.appendChild(div);
  return div;
}

var createSingleLoginLayer = getSingle(createLoginLayer);

document.getElementById('loginBtn').onclick = function () {
  var loginLayer = createSingleLoginLayer();
  loginLayer.style.display = 'block';
}
```

# 策略模式

一个基于策略模式的程序至少由两部分组成:第一部分是一组策略类，策略类封装了具体的算法,并负责具体的计算过程。第二个部分是环境类Context，Context接受客户的请求,随后把请求委托给某一个策略类。说明Context中药维持对某个策略对象的引用。

## 计算金额

```javascript
// 策略类
var strategies = {
  "S": function (salary) {
    return salary * 4;
  },

  "A": function (salary) {
    return salary * 3;
  },
  "B": function (salary) {
    return salary * 2;
  }
}

//环境类
var calculateBonus = function (level,salary) {
  return strategies[level](salary);
}

calculateBonus('S',20000);
```

## 实现动画

缓动算法:接受4个参数,动画已消耗的时间,小球原始位置，小球目标位置,动画持续,返回值是动画元素应该处在的当前位置。

```javascript
var tween = {
  linear: function (t,b,c,d) {
    return c*t/d + b;
  },
  easeIn: function (t,b,c,d) {
    return c*(t/=d)*t+b;
  },
  strongEaseIn: function (t,b,c,d) {
    return c*(t/=d)*t*t*t*t+b;
  },
  strongEaseOut: function (t,b,c,d) {
    return c*((t=t/d-1)*t*t*t*t+1)+b
  }
}

var Animate = function (dom) {
  this.dom = dom;
  this.startTime = 0;
  this.startPos = 0;
  this.endPos = 0;
  this.propertyName = null;
  this.easing = null;
  this.duration = null;
}

Animate.prototype.start = function (propertyName,endPos,duration,easing) {
  this.startTime = +new Date;
  this.starPos = this.dom.getBoundingClientRect()[propertyName];
  this.propertyName = propertyName;
  this.endPos = endPos;
  this.duration = duration;
  this.easing = tween[easing];

  var self = this;
  var timeId = setInterval(function () {
    if (self.step()===false) {
      clearInterval(timeId);
    }
  },19)
};

Animate.prototype.step = function () {
  var t = +new Date;
  if (t>=this.startTime +this.duration) {
    this.update(this.endPos);
    return false;
  }
  var pos = this.easing(t-this.startTime,this.startPos,this.endPos-this.startPos,this.duration);
  this.update(pos);
}

Animate.prototype.update = function (pos) {
  this.dom.style[this.propertyName] = pos + 'px'
}
```

## 表单校验

```html
<html>
    <head>
      <meta charset="utf-8">
      <title></title>
    </head>
    <body>
      <form action="index.html" method="post">
        请输入用户名:<input type="text" name="userName">
        请输入密码:<input type="text" name="password">
        请输入手机号码:<input type="text" name="phoneNumber">
        <button type="button" name="button">提交</button>
      </form>
      <script type="text/javascript">
      // 策略对象
      var strategies = {
        isNonEmpty: function (value,errorMsg) {
          if (value === '') {
            return errorMsg;
          }
        },
        minLength: function (value,lenght,errorMsg) {
          if (value.lenght<length) {
            return errorMsg;
          }
        },
        isMobile: function (value,errorMsg) {
          if (!/(^1[3|5|8][0-9]{9}$)/.test(value)) {
            return errorMsg;
          }
        }
      }
      // validator类
      var Validator = function () {
        this.cache = [];
      }

      Validator.prototype.add = function (dom,rules) {
        var self = this;
        for (var i = 0,rule;rule=rules[i++];) {
          (function (rule) {
            var strategyAry = rule.strategy.split(':');
            var errorMsg = rule.errorMsg;

            self.cache.push(function () {
              var strategy = strategyAry.shift();
              strategyAry.unshift(dom.value);
              strategyAry.push(errorMsg);

              return strategies[strategy].apply(dom,strategyAry);
            });
          })(rule)
        }
      };

      Validator.prototype.start = function () {
        for (var i = 0,validatorFunc;validatorFunc = this.cache[i++];) {
          var errorMsg = validatorFunc();
          if (errorMsg) {
            return errorMsg;
          }
        }
      };

      // 客户调用代码
      var registerForm = document.getElementById('registerForm');

      var validataFunc = function () {
        var validator = new Validator();

        validator.add(registerForm.userName,[{
          strategy:'isNonEmpty',
          errorMsg:'用户名不能为空'
        },{
          strategy:'minLength:10',
          errorMsg:'用户名长度不能小于10位'
        }]);

        var errorMsg = validator.start();
        return errorMsg;
      };

      registerForm.onsubmit = function () {
        var errorMsg = validataFunc();

        if (errorMsg) {
          alert(errorMsg);
          return false;
        }
      };

      </script>
    </body>
  </html>
```

# 代理模式

图片预加载

```javascript
var myImage = (function () {
    var imgNode = document.createElement('img');
    document.body.appendChild(imgNode);

    return {
      setSrc: function (src) {
        imgNode.src = src;
      }
    }
  })();

  var proxyImage = (function () {
    var img = new Image;
    img.onload = function () {
      myImage.setSrc(this.src);
    }

    return {
      setSrc: function (src) {
        myImage.setSrc('loading.gif')
        img.src = src;
      }
    }
  })();

  proxyImage.setSrc('a.jpg')
```

虚拟代理合并HTTP请求

```javascript
var synchronousFile = function (id) {
  console.log(id);
}

var proxySynchronousFile = (function () {
  var cache = [],
           timer;
 return function (id) {
   cache.push(id);
   if (timer) {
     return;
   }

   timer = setTimeout(function () {
     synchronousFile(cache.join(','));
     clearTImeout(timer);
     timer = null;
     cache.length = 0;
   },2000);
 }
})();

var checkbox = document.getElementByTagName('input');
for (var i = 0,c; c = checkbox[i++];) {
  c.onclick = function () {
    if (this.checked === true) {
      proxySynchronousFile(this.id);
    }
  }
};
```

缓存代理

```javascript
var proxyMult = (function () {
    var cache = {};
    return function () {
      var args = Array.prototype.join.call(arguments,',');
      if (args in cache) {
        return cache[args];
      }
      return cache[args] = mult.apply(this,arguments);
    }
  })();
```

用高阶函数动态创建代理

```javascript
var mult = function () {
  var a = 1;
  for (var i = 0,l=arguments.length; i < l; i++) {
    a = a*arguments[i];
  }
  return a;
};

var mult = function () {
  var a = 0;
  for (var i = 0,l=arguments.length; i < l; i++) {
    a = a+arguments[i];
  }
  return a;
};

var createProxyFactory = function (fn) {
  var cache = {};
  return function () {
    var args = Array.prototype.join.call(arguments,',');
    if (args in cache) {
      return cache[args];
    }
    return cache[args] = fn.apply(this,arguments);
  }
};

var proxyMult = createProxyFactory(mult),
    proxyPlus = createProxyFactory(plus);
```

# 迭代器模式

文件上传模块

```javascript
var getActiveUploadObj = function () {
    try{
      return new ActiveXObject("TXFTNActiveX.FTNUpload");
    }catch(e){
      return false;
    }
  };

  var getFlashUploadObj = function () {
    if (supportFlash()) {
      var str = '<object type="application/x-shockwave-flash"></object>';
      return $(str).appendTo($('body'));
    }
    return false;
  }

  var getFormUploadObj = function () {
    var str = '<input name="file" type="file" class="ui-file" />';
    return $(str).appendTo($('body'));
  }

  // 迭代器代码

  var iteratorUploadObj = function () {
    for (var i = 0,fn;fn = arguments[i++];) {
      var uploadObj = fn();
      if (uploadObj!==false) {
        return uploadObj;
      }
    }
  }

  var uploadObj = iteratorUploadObj(getActiveUploadObj,getFlashUploadObj,getFormUploadObj);
```

# 发布订阅模式

通用实现

```javascript
var event = {
    clientList:[],
    listen: function (key,fn) {
      if (!this.clientList[key]) {
        this.clientList[key] = [];
      }
      this.clientList[key].push(fn);
    },
    trigger: function () {
      var key = Array.prototype.shift.call(arguments),
      fns = this.clientList[key];

      if (!fns || fns.length === 0) {
        return false;
      }

      for (var i = 0,fn; fn=fns[i++];) {
        fn.apply(this,arguments);
      }
    }
  };

  var installEvent = function (obj) {
    for(var i in event){
      obj[i] = event[i];
    }
  };

  var salesOffices = {};
  installEvent(salesOffices);

  salesOffices.listen('squareMeter88',function (price) {
    console.log('价格='+price);
  });

  salesOffices.trigger('squareMeter88',200000);
```

# 命令模式

```javascript
var RefreshMenuBarCommand = function (receiver) {
    return {
      execute: function () {
        receiver.refresh();
      }
    }
  };

  var setCommand = function (button,command) {
    button.onclick = function () {
      command.execute();
    }
  }

  var refreshMenuBarCommand = RefreshMenuBarCommand(MenuBar);
  setCommand(button1,refreshMenuBarCommand);
```

小球运动与撤销

```javascript
var ball = document.getElementById('ball');
  var pos = document.getElementById('pos');
  var moveBtn = document.getElementById('moveBtn');
  var cancelBtn = document.getElementById('cancelBtn');

  var MoveCommand = function (receiver,pos) {
    this.receiver = receiver;
    this.pos = pos;
    this.olbPos = null;
  };

  MoveCommand.prototype.execute = function () {
    this.receiver.start('left',this.pos,1000,'strongEaseOut');
    this.oldPos = this.receiver.dom.getBoundingClientRect()[this.receiver.propertyName];
  }

  MoveCommand.prototype.undo = function () {
    this.receiver.start('left',this.oldPos,1000,'strongEaseOut')
  }

  var moveCommand;

  moveBtn.onclick =function () {
    var animate = new Animate(ball);
    moveCommand = new MoveCommand(animate,pos.value);
    moveCommand.execute();
  }

  cancelBtn.onclick = function () {
    moveCommand.undo();
  }
```

# 组合模式

扫描文件

```javascript
var Folder = function (name) {
  this.name = name;
  this.files = [];
};

Folder.prototype.add = function (file) {
  this.files.push(file);
}

Folder.prototype.scan = function () {
  console.log('开始扫描文件夹:' + this.name);
  for (var i = 0,file,files=this.files; file = files[i++];) {
    file.scan();
  }
}

var File = function (name) {
  this.name = name;
};

File.prototype.add = function () {
  throw new Error('文件下面不能添加文件');
};

File.prototype.scan = function () {
  console.log('开始扫描文件':+this.name);
}

var folder = new Folder('学习资料');
var file1 = new File('javascript')
```

# 模板方法模式

```javascript
var Coffee = function () {

};

var Beverage = function () {

}

Coffee.prototype = new Beverage();
```

钩子方法

```javascript
var Beverage = function () {

}

Beverage.prototype.brew = function () {
  throw new Error('子类必须重写brew方法');
};

Beverage.prototype.customerWantsCondiments = function () {
  return true;//默认需要调料
};

Beverage.prototype.init = function () {
  this.brew();
  if (this.customerWantsCondiments()) {
    this.addCondiments();
  }
}

```

# 享元模式

模特拍照

```js
  var Model = function (sex) {
    this.sex = sex;
  };

  Model.prototype.takePhoto = function () {
    console.log('sex='+this.sex+'underwear' + this.underwear );
  }

  var maleModel = new Model('male');
      femaleModel = new Model('female');

  for (var i = 0; i < 50; i++) {
    maleModel.underwart = 'underwear' + i;
    maleModel.takePhoto();
  }

  for (var j = 0; j < 50; j++) {
    femaleModel.underwart = 'underwear' + j;
    femaleModel.takePhoto();
  }
```

通用对象池实现

```js
  var objectPoolFactory = function (createObjFn) {
    var objectPool = [];

    return {
      create: function () {
        var obj = objectPool.lenght === 0?createObjFn.apply(this,arguments):objectPool.shift();
        return obj;
      },
      recover: function (obj) {
        objectPool.push(obj);
      }
    }
  }
```

# 职责链模式

```js
  var order500 = function (orderType,pay,stock) {
    if (orderType === 1 && pay === true) {
      console.log('500定金');
    }else{
      return 'nextSuccessor';
    }
  };

  var order200 = function (orderType,pay,stock) {
    if (orderType === 2 && pay === true) {
      console.log('200元定金预购,得到50元优惠券');
    }else{
      return 'nextSuccessor';
    }
  }

  var Chain = function (fn) {
    this.fn = fn;
    this.successor = null;
  }

  Chain.prototype.setNextSuccessor = function (successor) {
    return this.successor = successor;
  };

  Chain.prototype.passRequest = function () {
    var ret = this.fn.apply(this,arguments);

    if (ret === 'nextSuccessor') {
      return this.successor && this.successor.passRequest.apply(this.successor,arguments);
    }
    return ret;
  };

```

AOP实现

```js
  Function.prototype.after = function (fn) {
    var self = this;
    return function () {
      var ret = self.apply(this,arguments);
      if (ret==='nextSuccessor') {
        return fn.apply(this,arguments);
      }
      return ret;
    }
  }
```

# 中介者模式

```js
function Player(name,teamColor) {
  this.name = name;
  this.teamColor = teamColor;
  this.state = 'alive'
};

Player.prototype.win = function () {
  console.log(this.name + 'won');
}

Player.prototype.lose = function () {
  console.log(this.name + 'lost');
}

// 玩家死亡

Player.prototype.die = function () {
  this.state = 'dead';
  playerDirector.reciveMessage('playerDead',this);
}

var playerDirector = (function() {
    var players = {},
        operations = {};

    operations.addPlayer = function(player) {
        var teamColor = player.teamColor;
        players[teamColor] = players[teamColor] || [];
        players[teamColor].push(player);
    };

    operations.removePlayer = function(player) {
        var teamColor = player.teamColor,
            teamPlayers = players[teamColor] || [];
        for (var i = teamPlayers.length - 1; i >= 0; i--) {
            if (teamPlayers[i] === player) {
                teamPlayers.splice(i, 1);
            }
        }
    };
}
```

# 装饰者模式
```js
Function.prototype.before = function(beforefn) {
    var __self = this; // 保存原函数的ल用
    return function() { // 返回包դ˿原函数和新函数的"代ူ "函数
        beforefn.apply(this, arguments); // 执行新函数，且保᝼ this 不被ұ持，新函数ଋԩ的参数
        // ˶͗被原封不动͛ڠ入原函数，新函数ڙ原函数˧前执行
        return __self.apply(this, arguments); // 执行原函数并返回原函数的执行结果，
        // 并且保᝼ this 不被ұ持
    }
}
Function.prototype.after = function(afterfn) {
    var __self = this;
    return function() {
        var ret = __self.apply(this, arguments);
        afterfn.apply(this, arguments);
        return ret;
    }
};
```

# 状态模式

```js
var Light = function() {
    this.offLightState = new OffLightState(this); // 持有࿃খ对象的ल用
    this.weakLightState = new WeakLightState(this);
    this.strongLightState = new StrongLightState(this);
    this.superStrongLightState = new SuperStrongLightState(this);
    this.button = null;
};
Light.prototype.init = function() {
    var button = document.createElement('button'),
        self = this;
    this.button = document.body.appendChild(button);
    this.button.innerHTML = '开С ';
    this.currState = this.offLightState; // 设置᳭ᝢ初始࿃খ
    this.button.onclick = function() { // 定义用户的请ය动作
        self.currState.buttonWasPressed();
    }
};

```
